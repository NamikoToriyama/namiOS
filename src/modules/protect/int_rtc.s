;---------------------------------------
; RTCの割り込み設定
;---------------------------------------
rtc_int_en:
		;---------------------------------------
		; 【スタックフレームの構築】
		;---------------------------------------
												; ------|--------
												;    + 8| ビット
												; ------|--------
												;    + 4| EIP（戻り番地）
		push	ebp								; EBP+ 0| EBP（元の値）
		mov		ebp, esp						; ------+--------

		;---------------------------------------
		; 【レジスタの保存】
		;---------------------------------------
		push	eax

		;---------------------------------------
		; 割り込み許可設定
		;---------------------------------------
        outp    0x70, 0x0B                      ; レジスタBを選択

        in      al, 0x71                        ; レジスタB
        or      al, [ebp + 8]                   ; 指定されたビットをセットする

        out     0x71, al                        ; レジスタBに書き込み

		;---------------------------------------
		; 【レジスタの復帰】
		;---------------------------------------
		pop		eax

		;---------------------------------------
		; 【スタックフレームの破棄】
		;---------------------------------------
		mov		esp, ebp
		pop		ebp

		ret
        
int_rtc:
        ;-----------------------------------------
        ; 【レジスタの保存】
        ;-----------------------------------------
        pusha
        push    ds
        push    es

        ;-----------------------------------------
        ; データ用セグメントレジスタの設定
        ;-----------------------------------------
        mov     ax, 0x0010
        mov     ds, ax
        mov     es, ax

        ;-----------------------------------------
        ; RTCから時刻を取得
        ;-----------------------------------------
        cdecl   rtc_get_time, RTC_TIME

        ;-----------------------------------------
        ; RTCの割り込み要因を取得
        ;-----------------------------------------
        outp    0x70, 0x0C                         ; outp(0x70, 0x0C) // レジスタCを選択
        in      al, 0x71                           ; AL = port(0x71)

        ;-----------------------------------------
        ; 割り込みフラグをクリア
        ;-----------------------------------------
        mov     al, 0x20
        out     0xA0, al                           ; outp(スレーブPIC, AL)
        out     0x20, al                           ; outp(マスタPIC, AL) 

        ;-----------------------------------------
        ; 【レジスタの復帰】
        ;-----------------------------------------
        pop     es
        pop     ds
        popa

        iret                                        ; 割り込み処理の終了