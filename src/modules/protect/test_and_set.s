;************************************************************************
;	RTCから時刻データを取得する
;========================================================================
;■書式		: void test_and_set(local);
;
;■引数
;	local	: ローカル変数のアドレス
;
;■戻り値	: 無し
;************************************************************************
test_and_set:
		;---------------------------------------
		; 【スタックフレームの構築】
		;---------------------------------------
												; EBP+ 8| ローカル変数のアドレス
												; ------+----------------
		push	ebp								; EBP+ 4| EIP（戻り番地）
		mov		ebp, esp						; EBP+ 0| EBP（元の値）
												; ------+----------------

		;---------------------------------------
		; 【レジスタの保存】
		;---------------------------------------
		push	eax
		push	ebx

		;---------------------------------------
		; テストアンドセット
		;---------------------------------------
		mov		eax, 0							; local  = 0;
		mov		ebx, [ebp + 8]					; global = アドレス;

.10L:											; for ( ; ; )
												; {
		lock bts [ebx], eax						;   CF = TEST_AND_SET(IN_USE, 1);
		jnc		.10E							;   if (0 == CF)
												;     break;
												;   
.12L:											;   for ( ; ; )
												;   {
		bt		[ebx], eax						;     CF = TEST(IN_USE, 1);
		jc		.12L							;     if (0 == CF)
												;       break;
		jmp		.10L							;   }
.10E:											; }

		;---------------------------------------
		; 【レジスタの復帰】
		;---------------------------------------
		pop		ebx
		pop		eax

		;---------------------------------------
		; 【スタックフレームの破棄】
		;---------------------------------------
		mov		esp, ebp
		pop		ebp

		ret

