;************************************************************************
;	ページの初期化
;
		;---------------------------------------
		;          |____________| 
		; 0010_5000|       (4K) | ディレクトリテーブル
		;          =            = 
		;          |____________| 
		; 0010_6000|       (4K) | ページテーブル
		;          =            = 
		;          |____________| 
		; 0010_7000|       (4K) | ページフォルト用
		;          =            = 
		;          |____________| 
		;          |            | 
;
;************************************************************************
init_page:
		;---------------------------------------
		; 【レジスタの保存】
		;---------------------------------------
		pusha

		;---------------------------------------
		; ページ変換テーブルの作成
		;---------------------------------------
		cdecl	page_set_4m, CR3_BASE			; // ページ変換テーブルの作成：タスク3用

		;---------------------------------------
		; 【レジスタの復帰】
		;---------------------------------------
		popa

		ret


page_set_4m:
		;---------------------------------------
		; 【スタックフレームの構築】
		;---------------------------------------
												; ------|--------
		push	ebp								; EBP+ 0| EBP（元の値）
		mov		ebp, esp						; EBP+ 4| EIP（戻り番地）
												; ------|--------
												;    + 8| ページテーブル作成位置
												; ------|--------
		;---------------------------------------
		; 【レジスタの保存】
		;---------------------------------------
		pusha

		;---------------------------------------
		; ページディレクトリの作成
		;---------------------------------------
        cld                                     ; DFクリア
        mov     edi, [ebp + 8]                  ; ページディレクトリ先頭
        mov     eax, 0x00000000
        mov     ecx, 1024   
        rep     stosd

		;---------------------------------------
		; 先頭エントリを設定
		;---------------------------------------
        mov     eax, edi                        ; ページディレクトリの直後
        and     eax, ~0x0000_0FFF               ; 物理アドレスの指定
        or      eax, 7                          ; RWの許可
        mov     [edi - (1024* 4)], eax

        ;---------------------------------------
		; ページテーブルの設定
		;---------------------------------------
        mov     eax, 0x00000007
        mov     ecx, 1024                       ; 物理アドレスの指定とRWの許可

.10L:
        stosd
        add     eax, 0x00001000
        loop    .10L

		;---------------------------------------
		; 【レジスタの復帰】
		;---------------------------------------
		popa

		;---------------------------------------
		; 【スタックフレームの破棄】
		;---------------------------------------
		mov		esp, ebp
		pop		ebp

		ret
