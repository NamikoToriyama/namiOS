## 15 プロテクトモードへの移行
- リアルモードとプロテクトモードの大きな違い -> メモリ空間が保護されているか否か
    - プロテクトモードの全てのタスクが許可されたメモリ空間にいる必要がある
    - アクセス可能なメモリ空間を事前に設定しておく
- メモリ空間の保護
    - アクセスタイプによる保護
    - 特権レベルによる保護
- メモリ空間はセグメントディスクリプタで定義するz

## 16 プロテクトモードで画面出力する
- 画面出力はVRAM領域にデータを書き込む
    - 文字の描画はBIOSのフォントデータを用いて行う
    - 書き込む場所計算する必要がある(めんどくさいw)
- プレーン(白、赤緑青の光る板を制御するやつ)は読み込みプレーンと書き込みプレーンが存在する
プレーンの制御方法
```
mov     ah, 0x01        // プレーン選択
mov     al, 0x04        // 読み込みマップレジスタ(書き込みだったら0x02)
mov     dx, 0x03CE      // グラフィックス制御ポート(書き込みだったらシーケンサ制御ポート0x03C4を選択)
out     dx, ax          // ポート出力
```
- 文字と背景はandとかor演算をとって表示させる
- カラーバーは空白を表示させて背景色のみ表示する
- 線の描画
    - 点の描画の繰り返し
    - 傾斜で描画していく
    - 3/5のような斜めの線は増分を越えたがどうかで書く位置を決める

## 18 プロテクトモードでの割り込みを実現する
- 割り込み ... プログラムカウンタのレジスタの値を変更すること
    - ソフトウェア割り込み ... INT命令またはCPU内部でイベントが検出された時に発生する。無効にはできない。
    - ハードウェア割り込み ... CPUに接続された周辺機器から生成され、CPU命令により割り込みの発生、有効・無効を切り替えることができる
- 割り込みのメモリ空間はカーネルと同様にセグメントディスクリプタで定義する

## 18-1
- 割り込みは他の処理を優先して行う
- interrupt.sは呼び出し元に戻ることがないためレジスタの保存処理を行なっていない
- エラーコードがスタックされる

# 18-5
割り込み許可フラグを操作して割り込みを行う
## PIC(割り込みコントローラ)の初期化
マスターPICとスレーブPICがいる
- 割り込みコントローラを初期化 -> 個別の割り込みを作成 -> 必要な割り込みを有効

## RTC割り込み
- ポーリングを使用して実装していた
- ポーリングをすると一秒に数十回のポートアクセスが発生することになる
-> 大半が無駄なアクセスになる
- そのためデータ取得の割り込みタイミングをRTCからの割り込みで行うように設定する
    - 無駄なポートアクセスが不要になる
- ずっと表示がうまくいかなかったんだけどinit_intのせいでだめだったぽい

## キーボード割り込みを実装する
- RTCと一緒でキーボードも割り込みで実行すべき
- 手順
    - 割り込み処置の作成
    - 割り込み処理の登録
    - KBCの割り込み設定
    - PICの割り込みマスク設定
    - CPUの割り込み許可

- データはリングバッファに保存する
    - リングバッファ？？
    - 書き込み位置と読み込み位置により保存されたデータを管理するもの

謎のエラー`int_keyboard`の`pusha`を`popa`にしてたせい
謎のエラー`int_timer`の`pusha`を`popa`にしてたせい